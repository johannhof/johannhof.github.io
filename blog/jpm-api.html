<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>jpm as a Node module</title>
<link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha256-3dkvEK0WLHRJ7/Csr0BZjAWxERc5WH7bdeUya2aXxdU= sha512-+L4yy6FRcDGbXJ9mPG8MT/3UCDzwR9gPeyFNMCtInsol++5m3bk2bXWKdZjvybmohrAsn3Ua5x8gfLnbE1YkOg==" crossorigin="anonymous">
<link rel="stylesheet" href="/writ.min.css">
<link rel="stylesheet" href="/style.css" type="text/css" media="all" />
<link rel="alternate" href="/rss.xml" type="application/rss+xml" title="RSS" />

  </head>
<body data-route=blog>
  <nav class="menu">
  <a class="menu-item " href="/about/">Johann</a>
  <a class="menu-item current" href="/">Blog</a>
  <a class="menu-item" href="https://www.notion.so/johannhof/Johann-s-Scribbles-646639f7330b4147a2942172f36b6964">Scribbles</a>
  <a class="menu-item " href="/talks/">Talks</a>
  <a class="menu-item icon" href="http://github.com/johannhof"><i class="fa fa-github-square"></i></a>
  <a class="menu-item icon" href="http://twitter.com/johannh"><i class="fa fa-twitter-square"></i></a>
  <a class="menu-item icon" href="/rss.xml"><i class="fa fa-rss-square"></i></a>
  <hr>
</nav>

  <main>
    <article>
      <h1>jpm as a Node module</h1>
      <time pubdate="pubdate">Feb 11, 2016</time>
      <p>Despite my personal involvement in <a href="https://github.com/mozilla-jetpack/jpm">jpm</a> we've used <a href="https://developer.mozilla.org/en-US/Add-ons/SDK/Tools/cfx">cfx</a> at <a href="https://zenmate.com">ZenMate</a> for building
our Addon-SDK based Firefox extensions until it finally <a href="https://blog.mozilla.org/addons/2015/10/14/breaking-changes-let-const-firefox-nightly-44/">became obsolete</a>.
With cfx-based Addons now being more or less automatically rejected from <a href="https://addons.mozilla.org">addons.mozilla.org</a>, we made the transition to jpm.</p>
<p>This was long overdue, since jpm is better supported and installable from npm. As a bonus, we can finally <code>require('jpm')</code> in
our build tools instead of using <code>child_process.spawn</code> to run a cfx command.</p>
<p>We found that the internal jpm API is largely unknown and almost undocumented, so I thought this would be interesting to share.</p>
<h2>Requiring</h2>
<p>Almost all commands that you can run in jpm (init, run, xpi, test, post, sign) have a corresponding module in <code>jpm/lib</code>. That module exposes a function as its <code>module.exports</code>, which does exactly what the CLI command would do. So, to use <code>jpm run</code>, you can do</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">var run = require(&#39;jpm/lib/run&#39;);
</span></pre>
<h2>Running</h2>
<p>Here's a summary of the functions signatures:</p>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#c0c5ce;">init()
</span><span style="background-color:#2b303b;color:#c0c5ce;">run(manifest, options)
</span><span style="background-color:#2b303b;color:#c0c5ce;">test(manifest, options)
</span><span style="background-color:#2b303b;color:#c0c5ce;">xpi(manifest, options)
</span><span style="background-color:#2b303b;color:#c0c5ce;">post(manifest, options)
</span><span style="background-color:#2b303b;color:#c0c5ce;">sign(options, config)
</span></pre>
<p><code>manifest</code> simply means the <code>package.json</code> of your addon as a JavaScript object.</p>
<p><code>options</code> is an object where keys correspond to the CLI flags that are used by the different commands.
Note that keys in options are camelCased, while command-line flags use dashes. So <code>addon-dir</code> becomes <code>addonDir</code>.</p>
<p><code>xpi</code> and <code>post</code> take an additional option that is not specifiable on the command line: <code>xpiPath</code>. It determines the folder where the XPI should be saved. <code>run</code> and <code>test</code> will use a temporary location instead.</p>
<p><code>sign</code> takes <code>options</code> as its first parameter. The second parameter <code>config</code> takes can be used to override some internal mechanism, e.g. how the XPI should be created. You should check out the <a href="https://github.com/mozilla-jetpack/jpm/blob/master/lib/sign.js">source code</a> for more info.</p>
<blockquote>
<p>Warning: jpm sign will automatically submit addons to AMO, if you try to sign a listed addon it will <a href="https://github.com/mozilla-jetpack/jpm/issues/467">automatically be put up for review</a></p>
</blockquote>
<h2>Full Example</h2>
<pre style="background-color:#2b303b;">
<span style="background-color:#2b303b;color:#b48ead;">var </span><span style="background-color:#2b303b;color:#c0c5ce;">fs = </span><span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#c0c5ce;">(&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">fs</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;);
</span><span style="background-color:#2b303b;color:#b48ead;">var </span><span style="background-color:#2b303b;color:#bf616a;">xpi </span><span style="background-color:#2b303b;color:#c0c5ce;">= </span><span style="background-color:#2b303b;color:#8fa1b3;">require</span><span style="background-color:#2b303b;color:#c0c5ce;">(&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">jpm/lib/xpi</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;);

</span><span style="background-color:#2b303b;color:#65737e;">// get manifest contents 
</span><span style="background-color:#2b303b;color:#b48ead;">var </span><span style="background-color:#2b303b;color:#bf616a;">manifest </span><span style="background-color:#2b303b;color:#c0c5ce;">= </span><span style="background-color:#2b303b;color:#bf616a;">JSON</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#8fa1b3;">parse</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">fs</span><span style="background-color:#2b303b;color:#c0c5ce;">.</span><span style="background-color:#2b303b;color:#8fa1b3;">readFileSync</span><span style="background-color:#2b303b;color:#c0c5ce;">(&#39;</span><span style="background-color:#2b303b;color:#a3be8c;">/path/to/your/addon/package.json</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;, &#39;</span><span style="background-color:#2b303b;color:#a3be8c;">utf8</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;));

</span><span style="background-color:#2b303b;color:#65737e;">// like command line options
</span><span style="background-color:#2b303b;color:#b48ead;">var </span><span style="background-color:#2b303b;color:#bf616a;">options </span><span style="background-color:#2b303b;color:#c0c5ce;">= {
  addonDir: &#39;</span><span style="background-color:#2b303b;color:#a3be8c;">/path/to/your/addon</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;,
  xpiPath: &#39;</span><span style="background-color:#2b303b;color:#a3be8c;">/path/to/your/output/dir</span><span style="background-color:#2b303b;color:#c0c5ce;">&#39;
};

</span><span style="background-color:#2b303b;color:#65737e;">// create XPI
</span><span style="background-color:#2b303b;color:#8fa1b3;">xpi</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">manifest</span><span style="background-color:#2b303b;color:#c0c5ce;">, </span><span style="background-color:#2b303b;color:#bf616a;">options</span><span style="background-color:#2b303b;color:#c0c5ce;">).</span><span style="background-color:#2b303b;color:#8fa1b3;">then</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#b48ead;">function</span><span style="background-color:#2b303b;color:#c0c5ce;">(xpiPath) {
  console.</span><span style="background-color:#2b303b;color:#96b5b4;">log</span><span style="background-color:#2b303b;color:#c0c5ce;">(&quot;</span><span style="background-color:#2b303b;color:#a3be8c;">XPI saved at</span><span style="background-color:#2b303b;color:#c0c5ce;">&quot;, </span><span style="background-color:#2b303b;color:#bf616a;">xpiPath</span><span style="background-color:#2b303b;color:#c0c5ce;">);
}).</span><span style="background-color:#2b303b;color:#8fa1b3;">catch</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#b48ead;">function</span><span style="background-color:#2b303b;color:#c0c5ce;">(error) {
  console.</span><span style="background-color:#2b303b;color:#96b5b4;">error</span><span style="background-color:#2b303b;color:#c0c5ce;">(</span><span style="background-color:#2b303b;color:#bf616a;">error</span><span style="background-color:#2b303b;color:#c0c5ce;">);
});
</span></pre>
    </article>
  </main>
  <footer>
  <hr>
  <p>
    <a href="/license/">CC BY-SA 4.0 / MIT</a>
    -
    <a href="https://github.com/cobalt-org/cobalt.rs">Built with Cobalt</a>
  </p>
  <br>
</footer>

</body>
</html>
